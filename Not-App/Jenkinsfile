pipeline {
    agent any

    stages {

        stage('Checkout Code') {
            steps {
                echo 'Kod çekiliyor...'
                checkout scm
            }
        }

        stage('Build') {
            steps {
                echo 'Build ediliyor...'
                dir('Not-App') {
                    bat 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Unit Tests') {
            steps {
                echo 'Birim testler...'
                dir('Not-App') {
                    bat 'mvn test'
                }
            }
            post {
                always {
                    dir('Not-App') {
                        junit '**/target/surefire-reports/*.xml'
                    }
                }
            }
        }

        stage('Integration Tests') {
            steps {
                echo 'Entegrasyon testleri...'
                dir('Not-App') {
                    bat 'mvn verify'
                }
            }
            post {
                always {
                    dir('Not-App') {
                        junit '**/target/failsafe-reports/*.xml'
                    }
                }
            }
        }

        stage('5 - Run System in Docker') {
            steps {
                echo '========== Docker Compose ile sistem ayağa kaldırılıyor =========='
                powershell(script: '''
                    $ErrorActionPreference = "Stop"

                    Write-Host "== Önceki container'ları temizle =="
                    try {
                        docker-compose -f Not-App/docker-compose.yml down -v
                    } catch {
                        Write-Host "Hiçbir şey kaldırılmadı."
                    }

                    Write-Host "== DB ve Backend ayağa kaldırılıyor =="
                    docker-compose -f Not-App/docker-compose.yml up -d db app

                    Write-Host "== PostgreSQL hazır olması bekleniyor =="
                    for ($i=1; $i -le 30; $i++) {
                        try {
                            docker exec not-db pg_isready -U postgres -d notProjesi | Out-Null
                            Write-Host "✅ PostgreSQL hazır!"
                            break
                        } catch {
                            Write-Host "Bekleniyor... ($i/30)"
                            Start-Sleep -Seconds 2
                        }
                    }

                    Write-Host "== Backend hazır olması bekleniyor =="
                    for ($i=1; $i -le 60; $i++) {
                        try {
                            $res = Invoke-WebRequest -Uri http://localhost:8085/actuator/health -UseBasicParsing
                            if ($res.StatusCode -eq 200) {
                                Write-Host "✅ Backend hazır!"
                                break
                            }
                        } catch {}
                        Write-Host "Bekleniyor... ($i/60)"
                        Start-Sleep -Seconds 2
                    }

                    Write-Host "== Container durumları =="
                    docker-compose -f Not-App/docker-compose.yml ps
                ''')
            }
        }


    }
}
